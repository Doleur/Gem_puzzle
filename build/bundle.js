(()=>{"use strict";function t(){localStorage.setItem("time",P),localStorage.setItem("moves",w),localStorage.setItem("size",x);var t=0;document.querySelectorAll(".number").forEach((function(e){localStorage.setItem("".concat(t),JSON.stringify({class:e.className,style:e.style.cssText,id:e.id})),t++}));var e=document.querySelector(".empty"),i=Math.pow(x+1,2)-1;localStorage.setItem("".concat(i),JSON.stringify({class:e.className,style:e.style.cssText,id:e.id})),G()}var e;function i(){var t=document.querySelector(".puzzle");document.querySelector(".finish").remove();var e=document.createElement("section");t.appendChild(e),e.className="finish";var i=document.createElement("h2");e.append(i),i.classList.add("headScore"),i.innerHTML="BEST SCORE";var o=document.createElement("ul");e.append(o);for(var s=0;s<10;s++){var n=document.createElement("li");o.appendChild(n);var r=localStorage.getItem("arrScore").split(",")[s];localStorage.getItem("arrScore")&&r&&(n.innerHTML="".concat(s+1,". ").concat(r," moves"))}var a=document.createElement("button");e.appendChild(a),a.classList.add("btnMenu"),a.innerHTML="Back",a.addEventListener("click",R)}var o,s=!0;function n(){var t=document.querySelector(".puzzle");document.querySelector(".finish").remove();var e=document.createElement("section");t.appendChild(e),e.className="finish";var i=document.createElement("h2");e.append(i),i.classList.add("headScore"),i.innerHTML="SETTINGS";for(var o={0:"3 x 3",1:"4 x 4",2:"8 x 8"},n={0:"three",1:"four",2:"eight"},r=0;r<3;r++){var a=document.createElement("button");e.appendChild(a),a.classList.add("btnMenu","".concat(n[r])),a.innerHTML=o[r]}var h=document.querySelector(".three"),l=document.querySelector(".four"),c=document.querySelector(".eight");function d(t){z(),H(t)}h.addEventListener("click",(function(){d(3)})),l.addEventListener("click",(function(){d(4)})),c.addEventListener("click",(function(){d(8)}));var u=document.createElement("button");e.appendChild(u),u.classList.add("btnMenu","sound"),s?(u.innerHTML="Sound ON",u.addEventListener("click",(function(){u.innerHTML="Sound OFF",s=!s,document.querySelector("audio").remove()}))):(u.innerHTML="Sound OFF",u.addEventListener("click",(function(){u.innerHTML="Sound ON",s=!s,B()})));var m=document.createElement("button");e.appendChild(m),m.classList.add("btnMenu"),m.innerHTML="Back",m.addEventListener("click",R)}function r(t){this.grid=[],this.fixed=[],this.numbers=[],this.solution=[],this.originalGrid=t}r.prototype.setupSolver=function(){this.numbers=[],this.fixed=[],this.grid=[];for(var t=0;t<this.originalGrid.length;t++){this.fixed[t]=[],this.grid[t]=[];for(var e=0;e<this.originalGrid.length;e++){var i=this.originalGrid[t][e];this.grid[t][e]=i,this.fixed[t][e]=!1,this.numbers[i]={x:e,y:t}}}},r.prototype.solve=function(){this.setupSolver();try{this.solveGrid(this.grid.length)}catch(t){return console.log(t.message),null}return this.solution},r.prototype.solveGrid=function(t){t>2?(this.solveRow(t),this.solveColumn(t),this.solveGrid(t-1)):2===t&&(this.solveRow(t),""===this.grid[this.grid.length-1][this.grid.length-t]&&this.swapE({x:this.grid.length-1,y:this.grid.length-1}))},r.prototype.solveRow=function(t){for(var e=this.grid.length-t,i=e;i<this.grid.length-2;i++){var o=e*this.grid.length+(i+1);this.moveNumberTowards(o,{x:i,y:e}),this.fixed[e][i]=!0}var s=e*this.grid.length+this.grid.length-1,n=s+1;if(this.moveNumberTowards(s,{x:this.grid.length-1,y:e}),this.moveNumberTowards(n,{x:this.grid.length-1,y:e+1}),this.numbers[s].x!==this.grid.length-1||this.numbers[s].y!==e||this.numbers[n].x!==this.grid.length-1||this.numbers[n].y!==e+1){this.moveNumberTowards(s,{x:this.grid.length-1,y:e}),this.moveNumberTowards(n,{x:this.grid.length-2,y:e}),this.moveEmptyTo({x:this.grid.length-2,y:e+1});var r={x:this.grid.length-1,y:e+1};this.applyRelativeMoveList(r,["ul","u","","l","dl","d","","l","ul","u","","l","ul","u","","d"])}this.specialTopRightRotation(e)},r.prototype.solveColumn=function(t){for(var e=this.grid.length-t,i=e;i<this.grid.length-2;i++){var o=i*this.grid.length+1+e;this.moveNumberTowards(o,{x:e,y:i}),this.fixed[i][e]=!0}var s=(this.grid.length-2)*this.grid.length+1+e,n=s+this.grid.length;if(this.moveNumberTowards(s,{x:e,y:this.grid.length-1}),this.moveNumberTowards(n,{x:e+1,y:this.grid.length-1}),this.numbers[s].x!==e||this.numbers[s].y!==this.grid.length-1||this.numbers[n].x!==e+1||this.numbers[n].y!==this.grid.length-1){this.moveNumberTowards(s,{x:e,y:this.grid.length-1}),this.moveNumberTowards(n,{x:e,y:this.grid.length-2}),this.moveEmptyTo({x:e+1,y:this.grid.length-2});var r={x:e+1,y:this.grid.length-1};this.applyRelativeMoveList(r,["ul","l","","u","ur","r","","u","ul","l","","u","ul","l","","r"])}this.specialLeftBottomRotation(e)},r.prototype.applyRelativeMoveList=function(t,e){for(var i=0;i<e.length;i++)""===e[i]?this.swapE(t):this.swapE(this.offsetPosition(t,e[i]))},r.prototype.moveNumberTowards=function(t,e){if(this.numbers[t].x!==e.x||this.numbers[t].y!==e.y)for(this.makeEmptyNeighborTo(t);this.numbers[t].x!==e.x||this.numbers[t].y!==e.y;){var i=this.getDirectionToProceed(t,e);if(!this.areNeighbors(t,""))throw new Error("cannot rotate without empty");"u"===i||"d"===i?this.rotateVertical(t,"u"===i):this.rotateHorizontal(t,"l"===i)}},r.prototype.rotateHorizontal=function(t,e){var i=e?"l":"r",o=e?"r":"l",s=this.numbers[""],n=this.numbers[t];if(s.y!==n.y){var r=s.y<n.y?"u":"d";this.moveable(this.offsetPosition(n,r+i))&&this.moveable(this.offsetPosition(n,r))?(this.swapE(this.offsetPosition(n,r+i)),this.swapE(this.offsetPosition(n,i))):(this.swapE(this.offsetPosition(n,r+o)),this.swapE(this.offsetPosition(n,o)),this.proper3By2RotationHorizontal(n,e))}else(s.x<n.x&&!e||s.x>n.x&&e)&&this.proper3By2RotationHorizontal(n,e);this.swapE(n)},r.prototype.proper3By2RotationHorizontal=function(t,e){var i=e?"l":"r",o=e?"r":"l",s="u";if(this.moveable(this.offsetPosition(t,"d"+i))&&this.moveable(this.offsetPosition(t,"d"))&&this.moveable(this.offsetPosition(t,"d"+o)))s="d";else if(!this.moveable(this.offsetPosition(t,"u"+i))||!this.moveable(this.offsetPosition(t,"u"))||!this.moveable(this.offsetPosition(t,"u"+o)))throw new Error("unable to move up all spots fixed");this.swapE(this.offsetPosition(t,s+o)),this.swapE(this.offsetPosition(t,s)),this.swapE(this.offsetPosition(t,s+i)),this.swapE(this.offsetPosition(t,i))},r.prototype.rotateVertical=function(t,e){var i=e?"u":"d",o=e?"d":"u",s=this.numbers[""],n=this.numbers[t];if(s.x!==n.x){var r=s.x<n.x?"l":"r";this.moveable(this.offsetPosition(n,i+r))&&this.moveable(this.offsetPosition(n,r))?(this.swapE(this.offsetPosition(n,i+r)),this.swapE(this.offsetPosition(n,i))):(this.swapE(this.offsetPosition(n,o+r)),this.swapE(this.offsetPosition(n,o)),this.proper2By3RotationVertical(n,e))}else(s.y<n.y&&!e||s.y>n.y&&e)&&this.proper2By3RotationVertical(n,e);this.swapE(n)},r.prototype.proper2By3RotationVertical=function(t,e){var i=e?"u":"d",o=e?"d":"u",s="r";if(this.moveable(this.offsetPosition(t,i+"l"))&&this.moveable(this.offsetPosition(t,"l"))&&this.moveable(this.offsetPosition(t,o+"l")))s="l";else if(!this.moveable(this.offsetPosition(t,i+"r"))||!this.moveable(this.offsetPosition(t,"r"))||!this.moveable(this.offsetPosition(t,o+"r")))throw new Error("Unable to preform move, the puzzle is quite possibly unsolveable");this.swapE(this.offsetPosition(t,o+s)),this.swapE(this.offsetPosition(t,s)),this.swapE(this.offsetPosition(t,i+s)),this.swapE(this.offsetPosition(t,i))},r.prototype.specialTopRightRotation=function(t){this.fixed[t][this.grid.length-1]=!0,this.fixed[t+1][this.grid.length-1]=!0;var e={x:this.grid.length-1,y:t};this.moveEmptyTo(this.offsetPosition(e,"l")),this.swapE(e),this.swapE(this.offsetPosition(e,"d")),this.fixed[t+1][this.grid.length-1]=!1,this.fixed[e.y][e.x-1]=!0},r.prototype.specialLeftBottomRotation=function(t){this.fixed[this.grid.length-1][t]=!0,this.fixed[this.grid.length-1][t+1]=!0;var e={x:t,y:this.grid.length-1};this.moveEmptyTo(this.offsetPosition(e,"u")),this.swapE(e),this.swapE(this.offsetPosition(e,"r")),this.fixed[this.grid.length-1][t+1]=!1,this.fixed[e.y-1][e.x]=!0},r.prototype.getDirectionToProceed=function(t,e){var i=this.numbers[t],o=e.x-i.x,s=e.y-i.y;if(o<0&&this.moveable({x:i.x-1,y:i.y}))return"l";if(o>0&&this.moveable({x:i.x+1,y:i.y}))return"r";if(s<0&&this.moveable({x:i.x,y:i.y-1}))return"u";if(s>0&&this.moveable({x:i.x,y:i.y+1}))return"d";throw new Error("There is no valid move, the puzzle was incorrectly shuffled")},r.prototype.makeEmptyNeighborTo=function(t,e){for(var i=this.numbers[t],o=1;(this.numbers[""].x!==i.x||this.numbers[""].y!==i.y)&&!this.areNeighbors("",t);)if(this.movingEmptyLoop(i),++o>100)throw new Error("Infinite loop hit while solving the puzzle, it is quite likely this puzzle is invalid")},r.prototype.moveEmptyTo=function(t){if(this.fixed[t.y][t.x])throw new Error("cannot move empty to a fixed position");for(var e=1;this.numbers[""].x!==t.x||this.numbers[""].y!==t.y;)if(this.movingEmptyLoop(t),++e>100){console.log("problem trying to move the piece");break}},r.prototype.movingEmptyLoop=function(t){var e=this.numbers[""],i=e.x-t.x,o=e.y-t.y;i<0&&this.canSwap(e,this.offsetPosition(e,"r"))?this.swap(e,this.offsetPosition(e,"r")):i>0&&this.canSwap(e,this.offsetPosition(e,"l"))?this.swap(e,this.offsetPosition(e,"l")):o<0&&this.canSwap(e,this.offsetPosition(e,"d"))?this.swap(e,this.offsetPosition(e,"d")):o>0&&this.canSwap(e,this.offsetPosition(e,"u"))&&this.swap(e,this.offsetPosition(e,"u"))},r.prototype.offsetPosition=function(t,e){return"u"===e?{x:t.x,y:t.y-1}:"d"===e?{x:t.x,y:t.y+1}:"l"===e?{x:t.x-1,y:t.y}:"r"===e?{x:t.x+1,y:t.y}:"ul"===e?{x:t.x-1,y:t.y-1}:"ur"===e?{x:t.x+1,y:t.y-1}:"dl"===e?{x:t.x-1,y:t.y+1}:"dr"===e?{x:t.x+1,y:t.y+1}:t},r.prototype.areNeighbors=function(t,e){var i=this.numbers[t],o=this.numbers[e];return 1===Math.abs(i.x-o.x)&&i.y===o.y||1===Math.abs(i.y-o.y)&&i.x===o.x},r.prototype.moveable=function(t){return this.validPos(t)&&!this.fixed[t.y][t.x]},r.prototype.validPos=function(t){return!(t.x<0||t.x>=this.grid.length||t.y<0||t.y>=this.grid.length)},r.prototype.canSwap=function(t,e){if(!this.validPos(t)||!this.validPos(e))return!1;var i=this.grid[t.y][t.x],o=this.grid[e.y][e.x];return!!this.areNeighbors(i,o)&&!(this.fixed[t.y][t.x]||this.fixed[e.y][e.x])},r.prototype.swapE=function(t){this.swap(this.numbers[""],t)},r.prototype.swap=function(t,e){var i=this.grid[t.y][t.x],o=this.grid[e.y][e.x];if(!this.areNeighbors(i,o))throw new Error("These numbers are not neighbors and cannot be swapped");if(""!==i&&""!==o)throw new Error("You must swap with an empty space");var s=this.numbers[i];this.numbers[i]=this.numbers[o],this.numbers[o]=s,this.grid[t.y][t.x]=o,this.grid[e.y][e.x]=i,this.solution.push({empty:""===i?t:e,piece:""===i?e:t,number:""===i?o:i})};var a,h=document.createElement("header"),l=document.createElement("h1"),c=document.createElement("div"),d=document.createElement("p"),u=document.createElement("p"),m=document.createElement("button"),f=document.createElement("button"),p=document.createElement("div"),y=document.createElement("section"),v=document.createElement("h2"),g=document.createElement("p");document.body.append(h),h.append(l),h.append(c),c.appendChild(d),c.appendChild(u),c.appendChild(m),c.appendChild(f),document.body.append(p),document.body.append(y),y.append(v),y.append(g),p.className="puzzle",y.className="warning",v.innerHTML="WARNING!",g.innerHTML="Загрузку сохраненной игры проводить <b>только</b> на поле такого же размера. <br> Например: если вы сохранили игру 8x8, то и load нужно делать когда стоит 8x8",l.innerHTML="GEM PUZZLE",c.className="stat",m.className="pause",m.innerHTML="Pause",f.className="resume",f.innerHTML="Resume",f.style.display="none";var x,b,E=1,w=0;function S(){u.innerHTML="Moves: ".concat(w)}var L,T,P=0;function M(){L=P%60,T=Math.trunc(P/60),d.innerHTML="".concat(N(T),"<span>:</span>").concat(N(L)),P++,b=setTimeout(M,1e3)}function N(t){return(parseInt(t,10)<10?"0":"")+t}function H(t){var e,i,o;if(x=t-1,3===t&&(e=105),4===t&&(e=79),8===t&&(e=39),P=0,w=0,S(),E){p.innerHTML="";for(var s=1,n=0;n<=t-1;n++)for(var r=0;r<=t-1;r++){var a=document.createElement("div");a.id=n+"-"+r,a.style.left=r*e+1*r+1+"px",a.style.top=n*e+1*n+1+"px",s<=Math.pow(t,2)-1?(a.classList.add("number","el","el".concat(t)),a.setAttribute("draggable",!0),a.innerHTML=(s++).toString()):a.classList.add("empty","el".concat(t)),p.appendChild(a)}!function(){if(E){var t;E=0;var e=1,i=setInterval((function(){var o=10*Math.pow(x+1,2)*Math.ceil((x+1)/4);if(e<=o){var s=q(p.querySelector(".empty"));if(t)for(var n=s.length-1;n>=0;n--)s[n].innerHTML===t.innerHTML&&s.splice(n,1);k(t=s[Math.floor(Math.random()*s.length)]),e++}else clearInterval(i),E=1}),0)}}(),o=document.querySelector(".empty"),document.querySelectorAll(".number").forEach((function(t){t.addEventListener("dragstart",(function(t){(function(t){C(t)&&setTimeout((function(){t.classList.add("hide")}),0)})(t.target),i=t.target})),t.addEventListener("dragend",(function(t){!function(t){t.classList.remove("hide")}(t.target)}))})),o.addEventListener("dragover",(function(t){t.preventDefault()})),o.addEventListener("drop",(function(){1===E&&(w++,k(i))})),M()}}function I(t,e){return document.getElementById(t+"-"+e)}function q(t){var e=t.id.split("-"),i=parseInt(e[0]),o=parseInt(e[1]),s=[];return i<x&&s.push(I(i+1,o)),i>0&&s.push(I(i-1,o)),o<x&&s.push(I(i,o+1)),o>0&&s.push(I(i,o-1)),s}function C(t){for(var e=q(t),i=0;i<e.length;i++)if(/^empty/.test(e[i].className))return e[i];return!1}function k(t){if("empty"!==t.className){var i=C(t);if(i){s&&a&&a.play();var o={style:t.style.cssText,id:t.id};t.style.cssText=i.style.cssText,t.id=i.id,i.style.cssText=o.style,i.id=o.id,S(),1===E&&function(){if(/^empty/.test(I(x,x).className)){for(var t=1,i=Math.pow(x+1,2)-1,o=0;o<=x;o++)for(var s=0;s<=x;s++){if(t<=i&&I(o,s).innerHTML!==t.toString())return;t++}clearTimeout(b),function(t){if((e=localStorage.getItem("arrScore")?localStorage.getItem("arrScore").split(","):[]).length>10){if(e[9]<t)return;e.pop()}e.push(t),e.sort((function(t,e){return t-e})),e!==[]&&localStorage.setItem("arrScore",e.join(","))}(w),function(){var t=document.createElement("section");p.appendChild(t),t.className="finish";var e=document.createElement("h2");t.appendChild(e),e.innerHTML="Ура!";var i=document.createElement("p");t.appendChild(i),i.innerHTML="Вы решили головоломку";var o=document.createElement("p");t.appendChild(o),o.innerHTML=w>4?"за ".concat(N(T),":").concat(N(L)," и ").concat(w," ходов"):"за ".concat(N(T),":").concat(N(L)," и ").concat(w," хода");var s=document.createElement("button");s.className="restart",t.appendChild(s),s.innerHTML="Начать заново",s.addEventListener("click",(function(){H(x+1)}))}()}}()}}}function z(){m.style.display="",f.style.display="none"}function R(){document.querySelector(".finish")?document.querySelector(".finish").remove():(m.style.display="none",f.style.display="");var e=document.createElement("section");p.appendChild(e),e.className="finish";for(var s={0:"New game",1:"Save game",2:"Load game",3:"Best score",4:"Finish game",5:"Settings"},a={0:"newGame",1:"saveGame",2:"loadGame",3:"bestScore",4:"finishGame",5:"settings"},h=0;h<6;h++){var l=document.createElement("button");e.appendChild(l),l.classList.add("btnMenu","".concat(a[h])),l.innerHTML=s[h]}var c,d=document.querySelector(".newGame"),u=document.querySelector(".saveGame"),y=document.querySelector(".loadGame"),v=document.querySelector(".bestScore"),g=document.querySelector(".finishGame"),b=document.querySelector(".settings");d.addEventListener("click",(function(){z(),H(x+1)})),u.addEventListener("click",t),y.addEventListener("click",(function(){var t=localStorage.getItem("size");if(x===Number(t)){P=localStorage.getItem("time"),w=localStorage.getItem("moves"),S(),G();var e=0;document.querySelector(".empty").classList.add("el"),document.querySelectorAll(".el").forEach((function(t){var i=JSON.parse(localStorage.getItem("".concat(e)));t.className=i.class,t.id=i.id,t.style.cssText=i.style,e++}))}})),v.addEventListener("click",i),b.addEventListener("click",n),g.addEventListener("click",(function(){G(),function(){for(var t=[],e=0;e<=x;e++){for(var i=[],s=0;s<=x;s++)i.push(0===Number(document.getElementById("".concat(e,"-").concat(s)).textContent)?"":Number(document.getElementById("".concat(e,"-").concat(s)).textContent));t.push(i)}var n=new r(t);o=n.solve()}(),function(){var t,e,i=0;c=setInterval((function(){i<o.length?(t=o[i].piece.y,e=o[i].piece.x,k(document.getElementById(t+"-"+e)),w++,i++):clearInterval(c)}),300)}()}))}function G(){z(),document.querySelector(".finish").remove(),M()}function B(){a=document.createElement("audio"),document.body.append(a),a.setAttribute("src","../src/s.mp3"),a.setAttribute("muted","muted")}p.addEventListener("click",(function(t){C(t.target)&&(B(),1===E&&(w++,k(t.target)))})),m.addEventListener("click",(function(){clearTimeout(b),R()})),f.addEventListener("click",G),x=Number(localStorage.getItem("size")),localStorage.getItem("size")||H(4),H(x+1)})();